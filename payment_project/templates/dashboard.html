<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>User Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style> body { padding: 2rem; } </style>
</head>
<body>
    <div class="container">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h1>Dashboard</h1>
            <div>
                Welcome, <strong>{{ user.username }}</strong>!
                <a href="/admin/logout/" class="btn btn-sm btn-danger ms-2">Logout</a>
            </div>
        </div>

        <div class="card mb-4">
            <div class="card-header">Payment & File Upload</div>
            <div class="card-body">
                {% if not user_has_paid %}
                    <p>You need to complete a one-time payment of <strong>৳100</strong> to upload files.</p>
                    <form id="payment-form" method="POST">
                        <button type="button" id="pay-btn" class="btn btn-primary">Pay Now</button>
                    </form>
                {% else %}
                    <p class="text-success">✅ Payment complete! You can now upload files.</p>
                    <form id="upload-form" enctype="multipart/form-data">
                        <div class="mb-3">
                            <label for="file" class="form-label">Upload a .txt or .docx file</label>
                            <input class="form-control" type="file" id="file" name="file" accept=".txt,.docx" required>
                        </div>
                        <button type="submit" class="btn btn-success">Upload and Process</button>
                    </form>
                {% endif %}
            </div>
        </div>

        <div class="row">
            <div class="col-md-12 mb-4">
                <h3>Uploaded Files</h3>
                <table class="table table-striped">
                    <thead><tr><th>Filename</th><th>Status</th><th>Word Count</th><th>Uploaded At</th></tr></thead>
                    <tbody>
                        {% for file in files %}
                        <tr><td>{{ file.filename }}</td><td>{{ file.get_status_display }}</td><td>{{ file.word_count|default:"N/A" }}</td><td>{{ file.upload_time }}</td></tr>
                        {% empty %}
                        <tr><td colspan="4">No files uploaded yet.</td></tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            <div class="col-md-6">
                <h3>Activity Log</h3>
                <table class="table table-sm">
                    <thead><tr><th>Action</th><th>Timestamp</th></tr></thead>
                    <tbody>
                        {% for log in activities %}
                        <tr><td>{{ log.action }}</td><td>{{ log.timestamp }}</td></tr>
                        {% empty %}
                        <tr><td colspan="2">No activity yet.</td></tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            <div class="col-md-6">
                <h3>Payment History</h3>
                <table class="table table-sm">
                    <thead><tr><th>Transaction ID</th><th>Amount</th><th>Status</th><th>Timestamp</th></tr></thead>
                    <tbody>
                        {% for tx in transactions %}
                        <tr><td>{{ tx.transaction_id }}</td><td>{{ tx.amount }}</td><td>{{ tx.get_status_display }}</td><td>{{ tx.timestamp }}</td></tr>
                        {% empty %}
                        <tr><td colspan="4">No transactions yet.</td></tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        // CSRF Token for AJAX
        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }
        const csrftoken = getCookie('csrftoken');

        // Payment Initiation
        const payBtn = document.getElementById('pay-btn');
        if (payBtn) {
            payBtn.addEventListener('click', () => {
                fetch('/api/initiate-payment/', {
                    method: 'POST',
                    headers: {'X-CSRFToken': csrftoken, 'Content-Type': 'application/json'},
                })
                .then(res => res.json())
                .then(data => {
                    if (data.payment_url) {
                        window.location.href = data.payment_url;
                    } else {
                        alert('Error initiating payment.');
                    }
                });
            });
        }

        // File Upload
        const uploadForm = document.getElementById('upload-form');
        if(uploadForm) {
            uploadForm.addEventListener('submit', (e) => {
                e.preventDefault();
                const formData = new FormData(uploadForm);
                fetch('/api/upload/', {
                    method: 'POST',
                    headers: {'X-CSRFToken': csrftoken},
                    body: formData,
                })
                .then(res => res.json())
                .then(data => {
                    if(data.id) {
                        alert('File uploaded successfully! It is now being processed.');
                        location.reload();
                    } else {
                        alert('Error uploading file: ' + (data.error || 'Unknown error'));
                    }
                });
            });
        }
    </script>
</body>
</html>